
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A minimal DSPy-inspired library with native OpenAI tool calling">
      
      
      
        <link rel="canonical" href="https://silvestrid.github.io/udspy/architecture/decisions/">
      
      
        <link rel="prev" href="../overview/">
      
      
        <link rel="next" href="../lm/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Design Decisions - udspy</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architectural-decision-records-adr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="udspy" class="md-header__button md-logo" aria-label="udspy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            udspy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design Decisions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/silvestrid/udspy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    silvestrid/udspy
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../overview/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/basic_usage/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/signature/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="udspy" class="md-nav__button md-logo" aria-label="udspy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    udspy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/silvestrid/udspy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    silvestrid/udspy
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Design Decisions
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Design Decisions
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-001-initial-project-setup" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-001: Initial Project Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-001: Initial Project Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-native-tool-calling" class="md-nav__link">
    <span class="md-ellipsis">
      1. Native Tool Calling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-minimal-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      2. Minimal Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pydantic-v2" class="md-nav__link">
    <span class="md-ellipsis">
      3. Pydantic v2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-streaming-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      4. Streaming Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-module-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      5. Module Abstraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-002-context-manager-for-settings" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-002: Context Manager for Settings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-002: Context Manager for Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_1" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_1" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_1" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_1" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-003-chain-of-thought-module" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-003: Chain of Thought Module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-003: Chain of Thought Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_2" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_2" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-evidence" class="md-nav__link">
    <span class="md-ellipsis">
      Research Evidence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_1" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_2" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_2" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_1" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-004-human-in-the-loop-with-confirmation-system" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-004: Human-in-the-Loop with Confirmation System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-004: Human-in-the-Loop with Confirmation System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_3" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_3" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-types" class="md-nav__link">
    <span class="md-ellipsis">
      Key Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resumption-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Resumption Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#react-integration" class="md-nav__link">
    <span class="md-ellipsis">
      ReAct Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_2" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_2" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_3" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_3" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_2" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-005-react-agent-module" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-005: ReAct Agent Module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-005: ReAct Agent Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_4" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_4" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-approach_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_3" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-evidence_1" class="md-nav__link">
    <span class="md-ellipsis">
      Research Evidence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_3" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_4" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_4" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations_1" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_3" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-006-unified-module-execution-pattern-aexecute" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-006: Unified Module Execution Pattern (aexecute)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-006: Unified Module Execution Pattern (aexecute)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_5" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_5" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_2" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Key Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_5" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#before-and-after" class="md-nav__link">
    <span class="md-ellipsis">
      Before and After
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#naming-rationale" class="md-nav__link">
    <span class="md-ellipsis">
      Naming Rationale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_4" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Design Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Additional Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#field-markers-for-parsing" class="md-nav__link">
    <span class="md-ellipsis">
      Field Markers for Parsing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also_1" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-007-automatic-retry-on-parse-errors" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-007: Automatic Retry on Parse Errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-007: Automatic Retry on Parse Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_6" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_6" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_3" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_6" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_5" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_5" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations_2" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-008-module-callbacks-and-dynamic-tool-management" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-008: Module Callbacks and Dynamic Tool Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-008: Module Callbacks and Dynamic Tool Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_7" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_7" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_4" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_4" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_4" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_7" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_6" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_6" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_2" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-009-history-management-with-system-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-009: History Management with System Prompts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-009: History Management with System Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_8" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_8" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_5" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_5" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_5" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_8" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_7" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_7" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_3" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-010-lm-callable-interface-with-string-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-010: LM Callable Interface with String Prompts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-010: LM Callable Interface with String Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_9" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_9" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_6" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_6" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_6" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_9" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_8" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_8" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_4" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template-for-future-adrs" class="md-nav__link">
    <span class="md-ellipsis">
      Template for Future ADRs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-xxx-decision-title" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-XXX: Decision Title
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-XXX: Decision Title">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_10" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_10" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_7" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_10" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_9" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide-if-applicable" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide (if applicable)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LM Abstraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../signatures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Signatures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base Module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/predict/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Predict
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/chain_of_thought/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chain of Thought
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/react/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ReAct
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../confirmation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Confirmation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/basic_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/context_settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Context Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/chain_of_thought/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chain of Thought
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/tool_calling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool Calling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/react/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ReAct
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/dynamic_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dynamic Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/confirmation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Confirmation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conversation History
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/signature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Signatures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/module/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/adapter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/callback/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/module_callback/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/react/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ReAct
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/confirmation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Confirmation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-001-initial-project-setup" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-001: Initial Project Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-001: Initial Project Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-native-tool-calling" class="md-nav__link">
    <span class="md-ellipsis">
      1. Native Tool Calling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-minimal-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      2. Minimal Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pydantic-v2" class="md-nav__link">
    <span class="md-ellipsis">
      3. Pydantic v2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-streaming-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      4. Streaming Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-module-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      5. Module Abstraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-002-context-manager-for-settings" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-002: Context Manager for Settings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-002: Context Manager for Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_1" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_1" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_1" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_1" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-003-chain-of-thought-module" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-003: Chain of Thought Module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-003: Chain of Thought Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_2" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_2" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-evidence" class="md-nav__link">
    <span class="md-ellipsis">
      Research Evidence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_1" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_2" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_2" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_1" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-004-human-in-the-loop-with-confirmation-system" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-004: Human-in-the-Loop with Confirmation System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-004: Human-in-the-Loop with Confirmation System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_3" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_3" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-types" class="md-nav__link">
    <span class="md-ellipsis">
      Key Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resumption-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Resumption Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#react-integration" class="md-nav__link">
    <span class="md-ellipsis">
      ReAct Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_2" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_2" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_3" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_3" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_2" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-005-react-agent-module" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-005: ReAct Agent Module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-005: ReAct Agent Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_4" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_4" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-approach_1" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_3" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#research-evidence_1" class="md-nav__link">
    <span class="md-ellipsis">
      Research Evidence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_3" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_4" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_4" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations_1" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_3" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-006-unified-module-execution-pattern-aexecute" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-006: Unified Module Execution Pattern (aexecute)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-006: Unified Module Execution Pattern (aexecute)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_5" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_5" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_2" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Key Benefits
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_5" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#before-and-after" class="md-nav__link">
    <span class="md-ellipsis">
      Before and After
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#naming-rationale" class="md-nav__link">
    <span class="md-ellipsis">
      Naming Rationale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_4" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Additional Design Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Additional Design Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#field-markers-for-parsing" class="md-nav__link">
    <span class="md-ellipsis">
      Field Markers for Parsing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also_1" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-007-automatic-retry-on-parse-errors" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-007: Automatic Retry on Parse Errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-007: Automatic Retry on Parse Errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_6" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_6" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_3" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_6" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_5" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_5" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-considerations_2" class="md-nav__link">
    <span class="md-ellipsis">
      Future Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-008-module-callbacks-and-dynamic-tool-management" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-008: Module Callbacks and Dynamic Tool Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-008: Module Callbacks and Dynamic Tool Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_7" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_7" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_4" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_4" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_4" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_7" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_6" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_6" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_2" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-009-history-management-with-system-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-009: History Management with System Prompts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-009: History Management with System Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_8" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_8" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_5" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_5" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_5" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_8" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_7" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_7" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_3" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-010-lm-callable-interface-with-string-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-010: LM Callable Interface with String Prompts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-010: LM Callable Interface with String Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_9" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_9" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_6" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features_6" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cases_6" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_9" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_8" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide_8" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#see-also_4" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template-for-future-adrs" class="md-nav__link">
    <span class="md-ellipsis">
      Template for Future ADRs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adr-xxx-decision-title" class="md-nav__link">
    <span class="md-ellipsis">
      ADR-XXX: Decision Title
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADR-XXX: Decision Title">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context_10" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision_10" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details_7" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consequences_10" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternatives-considered_9" class="md-nav__link">
    <span class="md-ellipsis">
      Alternatives Considered
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-guide-if-applicable" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Guide (if applicable)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="architectural-decision-records-adr">Architectural Decision Records (ADR)</h1>
<p>This document tracks major architectural decisions made in udspy, presented chronologically with context, rationale, and consequences.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#adr-001-initial-project-setup">Initial Project Setup (2025-10-24)</a></li>
<li><a href="#adr-002-context-manager-for-settings">Context Manager for Settings (2025-10-24)</a></li>
<li><a href="#adr-003-chain-of-thought-module">Chain of Thought Module (2025-10-24)</a></li>
<li><a href="#adr-004-human-in-the-loop-with-confirmation-system">Human-in-the-Loop with Confirmation System (2025-10-25)</a></li>
<li><a href="#adr-005-react-agent-module">ReAct Agent Module (2025-10-25)</a></li>
<li><a href="#adr-006-unified-module-execution-pattern-aexecute">Unified Module Execution Pattern (aexecute) (2025-10-25)</a></li>
<li><a href="#adr-007-automatic-retry-on-parse-errors">Automatic Retry on Parse Errors (2025-10-29)</a></li>
<li><a href="#adr-008-module-callbacks-and-dynamic-tool-management">Module Callbacks and Dynamic Tool Management (2025-10-31)</a></li>
<li><a href="#adr-009-history-management-with-system-prompts">History Management with System Prompts (2025-10-31)</a></li>
<li><a href="#adr-010-lm-callable-interface-with-string-prompts">LM Callable Interface with String Prompts (2025-10-31)</a></li>
</ol>
<hr />
<h2 id="adr-001-initial-project-setup">ADR-001: Initial Project Setup</h2>
<p><strong>Date</strong>: 2025-10-24</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context">Context</h3>
<p>Needed a minimal library for LLM-powered applications in resource-constrained environments, specifically for Baserow's AI assistant where ~200MB dependencies are prohibitive.</p>
<h3 id="decision">Decision</h3>
<p>Build a lightweight library with:
- Native OpenAI tool calling as the primary approach
- Minimal dependencies (~10MB: <code>openai</code> + <code>pydantic</code>)
- Streaming support for reasoning and output fields
- Async-first architecture
- Modern Python tooling (uv, ruff, justfile)</p>
<p><strong>Note</strong>: Heavily inspired by <a href="https://github.com/stanfordnlp/dspy">DSPy's</a> excellent abstractions and API patterns.</p>
<h3 id="key-design-decisions">Key Design Decisions</h3>
<h4 id="1-native-tool-calling">1. Native Tool Calling</h4>
<p>Use OpenAI's native function calling API directly as the primary approach.</p>
<p><strong>Rationale</strong>:
- OpenAI's tool calling is optimized and well-tested
- Reduces complexity - no need for multi-provider adapter layer
- Forward compatible with future OpenAI improvements
- Works with any OpenAI-compatible provider (Together, Ollama, etc.)
- Sufficient for Baserow's AI assistant needs</p>
<p><strong>Trade-offs</strong>:
- Couples to OpenAI's API format (acceptable for our use case)
- Limited to OpenAI-compatible providers</p>
<h4 id="2-minimal-dependencies">2. Minimal Dependencies</h4>
<p>Only <code>openai</code> and <code>pydantic</code> in core dependencies.</p>
<p><strong>Rationale</strong>:
- Keeps the library lightweight (~10MB)
- Reduces potential dependency conflicts in Baserow
- Faster installation and lower memory usage
- Suitable for serverless, edge, and embedded deployments</p>
<p><strong>Trade-offs</strong>:
- Limited to OpenAI-compatible providers
- No multi-provider abstraction layer</p>
<h4 id="3-pydantic-v2">3. Pydantic v2</h4>
<p>Use Pydantic v2 for all models and validation.</p>
<p><strong>Rationale</strong>:
- Modern, fast, well-maintained
- Excellent JSON schema generation for tools
- Built-in validation and type coercion
- Great developer experience with IDE support</p>
<p><strong>Trade-offs</strong>:
- Requires Python 3.7+ (we target 3.11+)</p>
<h4 id="4-streaming-architecture">4. Streaming Architecture</h4>
<p>Async-first design using Python's async/await.</p>
<p><strong>Rationale</strong>:
- Python's async is the standard for I/O-bound operations
- Native support from OpenAI SDK
- Composable with Baserow's async infrastructure
- First-class support for streaming reasoning and outputs</p>
<p><strong>Trade-offs</strong>:
- Requires async runtime (asyncio)
- Steeper learning curve for beginners</p>
<h4 id="5-module-abstraction">5. Module Abstraction</h4>
<p>Modules compose via Python class inheritance.</p>
<p><strong>Rationale</strong>:
- Familiar Python patterns (no custom DSL)
- Good IDE and type checker support
- Signatures define I/O contracts using Pydantic models
- Predict is the core primitive for LLM calls</p>
<p><strong>Trade-offs</strong>:
- Requires more explicit code vs meta-programming approaches
- Less abstraction = more boilerplate for advanced use cases</p>
<h3 id="consequences">Consequences</h3>
<p><strong>Benefits</strong>:
- Small memory footprint (~10MB)
- Works in resource-constrained environments (Baserow AI assistant)
- Simple, maintainable codebase
- Compatible with any OpenAI-compatible provider
- Fast installation and startup</p>
<p><strong>Trade-offs</strong>:
- Limited to OpenAI-compatible providers
- No built-in optimizers or teleprompters
- Fewer abstractions = more manual work for complex scenarios</p>
<h3 id="alternatives-considered">Alternatives Considered</h3>
<ul>
<li><strong>Use existing frameworks</strong>: Larger footprints, more dependencies</li>
<li><strong>Build from scratch</strong>: Chose this - start minimal, add what's needed</li>
</ul>
<hr />
<h2 id="adr-002-context-manager-for-settings">ADR-002: Context Manager for Settings</h2>
<p><strong>Date</strong>: 2025-10-24</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_1">Context</h3>
<p>Need to support different API keys and models in different contexts (e.g., multi-tenant apps, different users, testing scenarios, concurrent async operations).</p>
<h3 id="decision_1">Decision</h3>
<p>Implement thread-safe context manager using Python's <code>contextvars</code> module:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">LM</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># Global settings</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">global_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;global-key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">global_lm</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># Temporary override in context</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">user_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;user-key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="k">with</span> <span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">user_lm</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>  <span class="c1"># Uses user-key and gpt-4</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1"># Back to global settings</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>  <span class="c1"># Uses global-key and gpt-4o-mini</span>
</code></pre></div>
<h3 id="implementation-details">Implementation Details</h3>
<ul>
<li>Added <code>ContextVar</code> fields to <code>Settings</code> class for each configurable attribute</li>
<li>Properties now check context first, then fall back to global settings</li>
<li>Context manager saves/restores context state using try/finally</li>
<li>Proper cleanup ensures no context leakage</li>
</ul>
<h3 id="key-features">Key Features</h3>
<ol>
<li><strong>Thread-Safe</strong>: Uses <code>ContextVar</code> for thread-safe context isolation</li>
<li><strong>Nestable</strong>: Contexts can be nested with proper inheritance</li>
<li><strong>Comprehensive</strong>: Supports overriding lm, callbacks, and any kwargs</li>
<li><strong>Clean API</strong>: Simple context manager interface with LM instances</li>
<li><strong>Flexible</strong>: Use different LM providers per context</li>
</ol>
<h3 id="use-cases">Use Cases</h3>
<ol>
<li>
<p><strong>Multi-tenant applications</strong>: Different API keys per user
   <div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">user_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">with</span> <span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">user_lm</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Model selection per request</strong>: Use different models for different tasks
   <div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">powerful_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">with</span> <span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">powerful_lm</span><span class="p">):</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">expensive_predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">complex_question</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Testing</strong>: Isolate test settings without affecting global state
   <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">test_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;sk-test&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">with</span> <span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">test_lm</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="k">assert</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;2+2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">answer</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Async operations</strong>: Safe concurrent operations with different settings
   <div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="n">user_lm</span> <span class="o">=</span> <span class="n">LM</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">with</span> <span class="n">udspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">user_lm</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">streaming_predictor</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>            <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="consequences_1">Consequences</h3>
<p><strong>Benefits</strong>:
- Clean separation of concerns (global vs context-specific settings)
- No need to pass settings through function parameters
- Thread-safe and asyncio task-safe for concurrent operations
- Flexible and composable</p>
<p><strong>Trade-offs</strong>:
- Slight complexity increase in Settings class
- Context variables have a small performance overhead (negligible)
- Must remember to use context manager (but gracefully degrades to global settings)</p>
<h3 id="alternatives-considered_1">Alternatives Considered</h3>
<ul>
<li><strong>Dependency Injection</strong>: More verbose, harder to use</li>
<li><strong>Environment Variables</strong>: Not dynamic enough for multi-tenant use cases</li>
<li><strong>Pass settings everywhere</strong>: Too cumbersome</li>
</ul>
<h3 id="migration-guide">Migration Guide</h3>
<p>No migration needed - feature is additive and backwards compatible.</p>
<hr />
<h2 id="adr-003-chain-of-thought-module">ADR-003: Chain of Thought Module</h2>
<p><strong>Date</strong>: 2025-10-24</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_2">Context</h3>
<p>Chain of Thought (CoT) is a proven prompting technique that improves LLM reasoning by explicitly requesting step-by-step thinking. Research shows ~25-30% accuracy improvement on math and reasoning tasks (Wei et al., 2022).</p>
<h3 id="decision_2">Decision</h3>
<p>Implement <code>ChainOfThought</code> module that automatically adds a reasoning field to any signature:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">QA</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Answer questions.&quot;&quot;&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">InputField</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="c1"># Automatically extends to: question -&gt; reasoning, answer</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">cot</span> <span class="o">=</span> <span class="n">ChainOfThought</span><span class="p">(</span><span class="n">QA</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">result</span> <span class="o">=</span> <span class="n">cot</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 15 * 23?&quot;</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">reasoning</span><span class="p">)</span>  <span class="c1"># Shows step-by-step calculation</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>     <span class="c1"># &quot;345&quot;</span>
</code></pre></div>
<h3 id="implementation-approach">Implementation Approach</h3>
<p>Unlike DSPy which uses a <code>signature.prepend()</code> method, udspy takes a simpler approach:</p>
<ol>
<li><strong>Extract fields</strong> from original signature</li>
<li><strong>Create extended outputs</strong> with reasoning prepended: <code>{"reasoning": str, **original_outputs}</code></li>
<li><strong>Use make_signature</strong> to create new signature dynamically</li>
<li><strong>Wrap in Predict</strong> with the extended signature</li>
</ol>
<p>This approach:
- Doesn't require adding prepend/insert methods to Signature
- Leverages existing <code>make_signature</code> utility
- Keeps ChainOfThought as a pure Module wrapper
- Only ~45 lines of code</p>
<h3 id="key-features_1">Key Features</h3>
<ol>
<li><strong>Automatic reasoning field</strong>: No manual signature modification needed</li>
<li><strong>Customizable description</strong>: Override reasoning field description</li>
<li><strong>Works with any signature</strong>: Single or multiple outputs</li>
<li><strong>Transparent</strong>: Reasoning is always accessible in results</li>
<li><strong>Configurable</strong>: All Predict parameters (model, temperature, tools) supported</li>
</ol>
<h3 id="research-evidence">Research Evidence</h3>
<p>Chain of Thought prompting improves performance on:
- <strong>Math</strong>: ~25-30% accuracy improvement (Wei et al., 2022)
- <strong>Reasoning</strong>: Significant gains on logic puzzles
- <strong>Multi-step</strong>: Better at complex multi-hop reasoning
- <strong>Transparency</strong>: Shows reasoning for verification</p>
<h3 id="use-cases_1">Use Cases</h3>
<ol>
<li>
<p><strong>Math and calculation</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">cot</span> <span class="o">=</span> <span class="n">ChainOfThought</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">result</span> <span class="o">=</span> <span class="n">cot</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 157 * 234?&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Analysis and decision-making</strong>
   <div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Decision</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">scenario</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">InputField</span><span class="p">()</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">decision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="n">justification</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">decider</span> <span class="o">=</span> <span class="n">ChainOfThought</span><span class="p">(</span><span class="n">Decision</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Educational applications</strong>: Show work/reasoning</p>
</li>
<li><strong>High-stakes decisions</strong>: Require explicit justification</li>
<li><strong>Debugging</strong>: Understand why LLM made specific choices</li>
</ol>
<h3 id="consequences_2">Consequences</h3>
<p><strong>Benefits</strong>:
- Improved accuracy on reasoning tasks
- Transparent reasoning process
- Easy to verify correctness
- Simple API (just wrap any signature)
- Minimal code overhead</p>
<p><strong>Trade-offs</strong>:
- Increased token usage (~2-3x for simple tasks)
- Slightly higher latency
- Not always needed for simple factual queries
- Reasoning quality depends on model capability</p>
<h3 id="alternatives-considered_2">Alternatives Considered</h3>
<ul>
<li><strong>Prompt Engineering</strong>: Less reliable than structured reasoning field</li>
<li><strong>Tool-based Reasoning</strong>: Too heavyweight for simple reasoning</li>
<li><strong>Custom Signature per Use</strong>: Too much boilerplate</li>
</ul>
<h3 id="future-considerations">Future Considerations</h3>
<ol>
<li><strong>Streaming support</strong>: StreamingChainOfThought for incremental reasoning</li>
<li><strong>Few-shot examples</strong>: Add example reasoning patterns to improve quality</li>
<li><strong>Verification</strong>: Automatic reasoning quality checks</li>
<li><strong>Caching</strong>: Built-in caching for repeated queries</li>
</ol>
<h3 id="migration-guide_1">Migration Guide</h3>
<p>Feature is additive - no migration needed.</p>
<hr />
<h2 id="adr-004-human-in-the-loop-with-confirmation-system">ADR-004: Human-in-the-Loop with Confirmation System</h2>
<p><strong>Date</strong>: 2025-10-25 (Updated: 2025-10-31)</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_3">Context</h3>
<p>Many agent applications require human approval for certain actions (e.g., deleting files, sending emails, making purchases). We needed a clean way to suspend execution, ask for user input, and resume where we left off. The system must support:
- Multiple confirmation rounds (clarifications, edits, iterations)
- State preservation for resumption
- Thread-safe concurrent operations
- Integration with ReAct agent trajectories</p>
<h3 id="decision_3">Decision</h3>
<p>Implement exception-based confirmation system with:
- <strong>Exceptions for control flow</strong>: <code>ConfirmationRequired</code>, <code>ConfirmationRejected</code>
- <strong>@confirm_first decorator</strong>: Wraps functions to require confirmation
- <strong>ResumeState</strong>: Container for resuming execution after confirmation
- <strong>Type-safe status tracking</strong>: Literal types for compile-time validation
- <strong>Thread-safe context</strong>: Uses <code>contextvars</code> for isolated state</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="n">confirm_first</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">ConfirmationRequired</span><span class="p">,</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">ConfirmationRejected</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">ResumeState</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">respond_to_confirmation</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="nd">@confirm_first</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1"># Interactive loop pattern</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="n">resume_state</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">delete_file</span><span class="p">(</span><span class="s2">&quot;/important.txt&quot;</span><span class="p">,</span> <span class="n">resume_state</span><span class="o">=</span><span class="n">resume_state</span><span class="p">)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="k">break</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="k">except</span> <span class="n">ConfirmationRequired</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">question</span><span class="si">}</span><span class="s2"> (yes/no): &quot;</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>        <span class="n">resume_state</span> <span class="o">=</span> <span class="n">ResumeState</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    <span class="k">except</span> <span class="n">ConfirmationRejected</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rejected: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="k">break</span>
</code></pre></div>
<h3 id="implementation-details_1">Implementation Details</h3>
<ol>
<li><strong>Stable Confirmation IDs</strong>: Generated from <code>function_name:hash(args)</code> for idempotent resumption</li>
<li><strong>Type-safe Status</strong>: <code>ConfirmationStatus = Literal["pending", "approved", "rejected", "edited", "feedback"]</code></li>
<li><strong>ApprovalData TypedDict</strong>: Structured approval data with type safety</li>
<li><strong>ResumeState Container</strong>: Combines exception + user response for clean resumption API</li>
<li><strong>Context Storage</strong>: Thread-safe <code>ContextVar[dict[str, ApprovalData]]</code></li>
<li><strong>Tool Integration</strong>: <code>check_tool_confirmation()</code> for tool-level confirmations</li>
<li><strong>Automatic Cleanup</strong>: Confirmations cleared after successful execution</li>
</ol>
<h3 id="key-types">Key Types</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Type-safe status</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">ConfirmationStatus</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;approved&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;edited&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">]</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1"># Typed approval data</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ApprovalData</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">approved</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">ConfirmationStatus</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="c1"># Exception classes</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConfirmationRequired</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">confirmation_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">tool_call</span><span class="p">:</span> <span class="n">ToolCall</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># Module state for resumption</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConfirmationRejected</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="n">confirmation_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="n">tool_call</span><span class="p">:</span> <span class="n">ToolCall</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="c1"># Resume state container</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResumeState</span><span class="p">:</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">exception</span><span class="p">:</span> <span class="n">ConfirmationRequired</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="n">user_response</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="n">confirmation_id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Property</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Property</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>    <span class="n">tool_call</span><span class="p">:</span> <span class="n">ToolCall</span> <span class="o">|</span> <span class="kc">None</span>  <span class="c1"># Property</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># Property</span>
</code></pre></div>
<h3 id="resumption-patterns">Resumption Patterns</h3>
<p><strong>Pattern 1: Explicit respond_to_confirmation()</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="n">delete_file</span><span class="p">(</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">except</span> <span class="n">ConfirmationRequired</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">respond_to_confirmation</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">confirmation_id</span><span class="p">,</span> <span class="n">approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">delete_file</span><span class="p">(</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>  <span class="c1"># Resumes</span>
</code></pre></div></p>
<p><strong>Pattern 2: ResumeState loop (recommended)</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">resume_state</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">resume_state</span><span class="o">=</span><span class="n">resume_state</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="k">break</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="k">except</span> <span class="n">ConfirmationRequired</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">get_user_input</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="n">resume_state</span> <span class="o">=</span> <span class="n">ResumeState</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="react-integration">ReAct Integration</h3>
<p>ReAct automatically catches <code>ConfirmationRequired</code> and adds execution state:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="o">**</span><span class="n">tool_args</span><span class="p">)</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">except</span> <span class="n">ConfirmationRequired</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="c1"># ReAct enriches context with trajectory state</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="n">e</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>        <span class="s2">&quot;trajectory&quot;</span><span class="p">:</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>        <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="s2">&quot;input_args&quot;</span><span class="p">:</span> <span class="n">input_args</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="p">}</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">tool_call</span> <span class="ow">and</span> <span class="n">tool_call_id</span><span class="p">:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="n">e</span><span class="o">.</span><span class="n">tool_call</span><span class="o">.</span><span class="n">call_id</span> <span class="o">=</span> <span class="n">tool_call_id</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="k">raise</span>  <span class="c1"># Re-raise for caller</span>
</code></pre></div>
<p>This enables resuming from exact point in trajectory.</p>
<h3 id="key-features_2">Key Features</h3>
<ol>
<li><strong>Exception-based control</strong>: Natural suspension of call stack</li>
<li><strong>ResumeState container</strong>: Clean API for resumption with user response</li>
<li><strong>Type-safe</strong>: Literal types and TypedDict for status tracking</li>
<li><strong>Thread-safe</strong>: <code>ContextVar</code> isolation per thread/task</li>
<li><strong>Async-safe</strong>: Works with asyncio concurrent operations</li>
<li><strong>Module integration</strong>: Modules can save/restore state in exception context</li>
<li><strong>Tool confirmations</strong>: <code>check_tool_confirmation()</code> for tool-level checks</li>
<li><strong>Argument editing</strong>: Users can modify arguments before approval</li>
</ol>
<h3 id="use-cases_2">Use Cases</h3>
<ol>
<li><strong>Dangerous operations</strong>: File deletion, system commands, database changes</li>
<li><strong>User confirmation</strong>: Sending emails, making purchases, API calls</li>
<li><strong>Clarification loops</strong>: Ask user for additional information</li>
<li><strong>Argument editing</strong>: Let user modify parameters before execution</li>
<li><strong>Multi-step workflows</strong>: Multiple confirmation rounds in agent execution</li>
<li><strong>Web APIs</strong>: Save state in session, resume later</li>
<li><strong>Batch processing</strong>: Auto-approve low-risk, human review high-risk</li>
</ol>
<h3 id="consequences_3">Consequences</h3>
<p><strong>Benefits</strong>:
- Clean separation of business logic from approval logic
- Works naturally with ReAct agent trajectories
- Thread-safe and async-safe out of the box
- Easy to test (deterministic based on confirmation state)
- Type-safe with Literal types and TypedDict
- ResumeState provides clean resumption API
- Supports multiple confirmation rounds
- State preservation enables complex workflows</p>
<p><strong>Trade-offs</strong>:
- Requires exception handling (explicit and clear)
- Confirmation state is per-process (doesn't persist across restarts)
- Hash-based IDs could collide (extremely rare)
- Learning curve for exception-based control flow
- Must manage confirmation rounds to prevent infinite loops</p>
<h3 id="alternatives-considered_3">Alternatives Considered</h3>
<ul>
<li><strong>Callback-based</strong>: More complex, harder to reason about flow</li>
<li><strong>Async/await pattern</strong>: Breaks with mixed sync/async code</li>
<li><strong>Return sentinel values</strong>: Ambiguous, requires checking every return</li>
<li><strong>Async generators with yield</strong>: Breaks module composability</li>
<li><strong>Middleware pattern</strong>: Too heavyweight for this use case</li>
<li><strong>Global registry</strong>: Testing difficulties, not thread-safe</li>
<li><strong>Manual state management</strong>: Error-prone, inconsistent</li>
</ul>
<h3 id="migration-guide_2">Migration Guide</h3>
<p>Feature is additive - no migration needed.</p>
<p><strong>Basic usage</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nd">@confirm_first</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">dangerous_op</span><span class="p">():</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="o">...</span>
</code></pre></div></p>
<p><strong>Recommended pattern</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResumeState</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">resume_state</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">resume_state</span><span class="o">=</span><span class="n">resume_state</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="k">break</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">except</span> <span class="n">ConfirmationRequired</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">question</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="n">resume_state</span> <span class="o">=</span> <span class="n">ResumeState</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="see-also">See Also</h3>
<ul>
<li><a href="../confirmation/">Confirmation Architecture</a> - Detailed architecture and patterns</li>
<li><a href="../../api/confirmation/">Confirmation API</a> - API documentation</li>
<li><a href="../modules/react/">ReAct Module</a> - Integration with agents</li>
</ul>
<hr />
<h2 id="adr-005-react-agent-module">ADR-005: ReAct Agent Module</h2>
<p><strong>Date</strong>: 2025-10-25</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_4">Context</h3>
<p>The ReAct (Reasoning + Acting) pattern combines chain-of-thought reasoning with tool usage in an iterative loop. This is essential for building agents that can solve complex tasks by breaking them down and using tools.</p>
<h3 id="decision_4">Decision</h3>
<p>Implement a <code>ReAct</code> module that:
- Alternates between reasoning and tool execution
- Supports human-in-the-loop for clarifications and confirmations
- Tracks full trajectory of reasoning and actions
- Handles errors gracefully with retries
- Works with both streaming and non-streaming modes</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReAct</span><span class="p">,</span> <span class="n">InputField</span><span class="p">,</span> <span class="n">OutputField</span><span class="p">,</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">tool</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;search&quot;</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">return</span> <span class="n">search_api</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResearchTask</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Research and answer questions.&quot;&quot;&quot;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">InputField</span><span class="p">()</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">ResearchTask</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search</span><span class="p">],</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="n">result</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is the population of Tokyo?&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="implementation-approach_1">Implementation Approach</h3>
<ol>
<li><strong>Iterative Loop</strong>: Continues until final answer or max iterations</li>
<li><strong>Dynamic Signature</strong>: Extends signature with reasoning_N, tool_name_N, tool_args_N fields</li>
<li><strong>Tool Execution</strong>: Automatically executes tools and adds results to context</li>
<li><strong>Error Handling</strong>: Retries with error feedback if tool execution fails</li>
<li><strong>Human Confirmations</strong>: Integrates with <code>@confirm_first</code> for user input</li>
</ol>
<h3 id="key-features_3">Key Features</h3>
<ol>
<li><strong>Flexible Tool Usage</strong>: Agent decides when and which tools to use</li>
<li><strong>Self-Correction</strong>: Can retry if tool execution fails</li>
<li><strong>Trajectory Tracking</strong>: Full history of reasoning and actions</li>
<li><strong>Streaming Support</strong>: Can stream reasoning in real-time</li>
<li><strong>Human-in-the-Loop</strong>: Built-in support for asking users</li>
</ol>
<h3 id="research-evidence_1">Research Evidence</h3>
<p>ReAct improves performance on:
- <strong>Complex Tasks</strong>: 15-30% improvement on multi-step reasoning (Yao et al., 2023)
- <strong>Tool Usage</strong>: More accurate tool selection vs. pure CoT
- <strong>Error Recovery</strong>: Better handling of failed tool calls</p>
<h3 id="use-cases_3">Use Cases</h3>
<ol>
<li><strong>Research Agents</strong>: Answer questions using search and APIs</li>
<li><strong>Task Automation</strong>: Multi-step workflows with tool usage</li>
<li><strong>Data Analysis</strong>: Fetch data, analyze, and summarize</li>
<li><strong>Interactive Assistants</strong>: Ask users for clarification when needed</li>
</ol>
<h3 id="consequences_4">Consequences</h3>
<p><strong>Benefits</strong>:
- Powerful agent capabilities with minimal code
- Transparent reasoning process
- Handles complex multi-step tasks
- Built-in error handling and retries</p>
<p><strong>Trade-offs</strong>:
- Higher token usage due to multiple iterations
- Slower than single-shot predictions
- Quality depends on LLM's reasoning ability
- Can get stuck in loops if not properly configured</p>
<h3 id="alternatives-considered_4">Alternatives Considered</h3>
<ul>
<li><strong>Chain-based approach</strong>: Too rigid, hard to add dynamic behavior</li>
<li><strong>State machine</strong>: Overly complex for the use case</li>
<li><strong>Pure prompting</strong>: Less reliable than structured approach</li>
</ul>
<h3 id="future-considerations_1">Future Considerations</h3>
<ol>
<li><strong>Memory/History</strong>: Long-term memory across sessions</li>
<li><strong>Tool Chaining</strong>: Automatic sequencing of tool calls</li>
<li><strong>Parallel Tool Execution</strong>: Execute independent tools concurrently</li>
<li><strong>Learning</strong>: Optimize tool selection based on feedback</li>
</ol>
<h3 id="migration-guide_3">Migration Guide</h3>
<p>Feature is additive - no migration needed.</p>
<hr />
<h2 id="adr-006-unified-module-execution-pattern-aexecute">ADR-006: Unified Module Execution Pattern (aexecute)</h2>
<p><strong>Date</strong>: 2025-10-25</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_5">Context</h3>
<p>Initially, <code>astream()</code> and <code>aforward()</code> had duplicated logic for executing modules. This made maintenance difficult and increased the chance of bugs when updating behavior.</p>
<h3 id="decision_5">Decision</h3>
<p>Introduce a single <code>aexecute()</code> method that handles both streaming and non-streaming execution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Module</span><span class="p">:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aexecute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Core execution logic - handles both streaming and non-streaming.&quot;&quot;&quot;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        <span class="c1"># Implementation here</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Public streaming API.&quot;&quot;&quot;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aexecute</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>            <span class="k">yield</span> <span class="n">event</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aforward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Public non-streaming API.&quot;&quot;&quot;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aexecute</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">Prediction</span><span class="p">):</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>                <span class="k">return</span> <span class="n">event</span>
</code></pre></div>
<h3 id="implementation-details_2">Implementation Details</h3>
<ol>
<li><strong>Single Source of Truth</strong>: All execution logic in <code>aexecute()</code></li>
<li><strong>Stream Parameter</strong>: Boolean flag controls behavior</li>
<li><strong>Generator Pattern</strong>: Always yields events, even in non-streaming mode</li>
<li><strong>Clean Separation</strong>: Public methods are thin wrappers</li>
</ol>
<h3 id="key-benefits">Key Benefits</h3>
<ol>
<li><strong>No Duplication</strong>: Write logic once, use in both modes</li>
<li><strong>Easier Testing</strong>: Test one method instead of two</li>
<li><strong>Consistent Behavior</strong>: Streaming and non-streaming guaranteed to behave identically</li>
<li><strong>Maintainable</strong>: Changes only need to be made in one place</li>
<li><strong>Extensible</strong>: Easy to add new execution modes</li>
</ol>
<h3 id="consequences_5">Consequences</h3>
<p><strong>Benefits</strong>:
- Reduced code duplication (~40% less code in modules)
- Easier to maintain and debug
- Consistent behavior across modes
- Simpler to understand (one execution path)</p>
<p><strong>Trade-offs</strong>:
- Slightly more complex to implement initially
- Need to handle both streaming and non-streaming cases in same method
- Generator pattern requires understanding of async generators</p>
<h3 id="before-and-after">Before and After</h3>
<p><strong>Before:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="c1"># 100 lines of logic</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="o">...</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aforward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="c1"># 100 lines of DUPLICATED logic with minor differences</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="o">...</span>
</code></pre></div></p>
<p><strong>After:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aexecute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="c1"># 100 lines of logic (used by both)</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="o">...</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aexecute</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>        <span class="k">yield</span> <span class="n">event</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aforward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aexecute</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">):</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">Prediction</span><span class="p">):</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>            <span class="k">return</span> <span class="n">event</span>
</code></pre></div></p>
<h3 id="naming-rationale">Naming Rationale</h3>
<p>We chose <code>aexecute()</code> (without underscore prefix) because:
- <strong>Public Method</strong>: This is the main extension point for subclasses
- <strong>Clear Intent</strong>: "Execute" is explicit about what it does
- <strong>Python Conventions</strong>: No underscore = public API, expected to be overridden
- <strong>Not Abbreviated</strong>: Full word avoids ambiguity (vs <code>aexec</code> or <code>acall</code>)</p>
<h3 id="migration-guide_4">Migration Guide</h3>
<p><strong>For Users</strong>: No changes needed - public API remains the same</p>
<p><strong>For Module Authors</strong>: When creating custom modules, implement <code>aexecute()</code> instead of both <code>astream()</code> and <code>aforward()</code>.</p>
<hr />
<h2 id="additional-design-decisions">Additional Design Decisions</h2>
<h3 id="field-markers-for-parsing">Field Markers for Parsing</h3>
<p><strong>Decision</strong>: Use <code>[[ ## field_name ## ]]</code> markers to delineate fields in completions.</p>
<p><strong>Rationale</strong>:
- Simple, regex-parseable format
- Clear visual separation
- Consistent with DSPy's approach (proven)
- Fallback when native tools aren't available</p>
<p><strong>Trade-offs</strong>:
- Requires careful prompt engineering
- LLM might not always respect markers
- Uses extra tokens</p>
<hr />
<h2 id="see-also_1">See Also</h2>
<ul>
<li><a href="https://github.com/silvestrid/udspy/blob/main/CLAUDE.md">CLAUDE.md</a> - Chronological architectural changes (development log)</li>
<li><a href="../overview/">Architecture Overview</a> - Component relationships</li>
<li><a href="https://github.com/silvestrid/udspy/blob/main/CONTRIBUTING.md">Contributing Guide</a> - How to propose new decisions</li>
</ul>
<hr />
<h2 id="adr-007-automatic-retry-on-parse-errors">ADR-007: Automatic Retry on Parse Errors</h2>
<p><strong>Date</strong>: 2025-10-29</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_6">Context</h3>
<p>LLMs occasionally generate responses that don't match the expected output format, causing <code>AdapterParseError</code> to be raised. This is especially common with:
- Field markers being omitted or malformed
- JSON parsing errors in structured outputs
- Missing required output fields
- Format inconsistencies</p>
<p>These errors are usually transient - the LLM can often generate a valid response on retry. Without automatic retry, users had to implement retry logic themselves, leading to boilerplate code and inconsistent error handling.</p>
<h3 id="decision_6">Decision</h3>
<p>Implement automatic retry logic using the <code>tenacity</code> library on both <code>Predict._aforward()</code> and <code>Predict._astream()</code> methods:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">retry_if_exception_type</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="nd">@retry</span><span class="p">(</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">AdapterParseError</span><span class="p">),</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="p">)</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_aforward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completion_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">should_emit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Prediction</span><span class="p">:</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process non-streaming LLM call with automatic retry on parse errors.</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="sd">    Retries up to 2 times (3 total attempts) with exponential backoff (0.1-3s)</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="sd">    when AdapterParseError occurs, giving the LLM multiple chances to format</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="sd">    the response correctly.</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>Key parameters</strong>:
- <strong>Max attempts</strong>: 3 (1 initial + 2 retries)
- <strong>Retry condition</strong>: Only retry on <code>AdapterParseError</code> (not other exceptions)
- <strong>Wait strategy</strong>: Exponential backoff starting at 0.1s, max 3s
- <strong>Applies to</strong>: Both streaming (<code>_astream</code>) and non-streaming (<code>_aforward</code>) execution</p>
<h3 id="implementation-details_3">Implementation Details</h3>
<ol>
<li><strong>Decorator location</strong>: Applied to internal <code>_aforward</code> and <code>_astream</code> methods (not public API methods)</li>
<li><strong>Tenacity library</strong>: Minimal dependency (~50KB) with excellent async support</li>
<li><strong>Error propagation</strong>: After 3 failed attempts, raises <code>tenacity.RetryError</code> wrapping the original <code>AdapterParseError</code></li>
<li><strong>Test isolation</strong>: Tests use a <code>fast_retry</code> fixture in <code>conftest.py</code> that patches retry decorators to use <code>wait_none()</code> for instant retries</li>
</ol>
<h3 id="consequences_6">Consequences</h3>
<p><strong>Benefits</strong>:
- <strong>Improved reliability</strong>: Transient parse errors are automatically recovered
- <strong>Better user experience</strong>: Users don't see spurious errors from LLM format issues
- <strong>Reduced boilerplate</strong>: No need for users to implement retry logic
- <strong>Consistent behavior</strong>: All modules get retry logic automatically
- <strong>Configurable backoff</strong>: Exponential backoff prevents API hammering</p>
<p><strong>Trade-offs</strong>:
- <strong>Increased latency on errors</strong>: Failed attempts add 0.1-3s delay per retry (max ~6s for 3 attempts)
- <strong>Hidden failures</strong>: First 2 parse errors are not visible to users (but logged internally)
- <strong>Token usage</strong>: Failed attempts consume tokens without producing results
- <strong>Test complexity</strong>: Tests need to mock/patch retry behavior to avoid slow tests</p>
<h3 id="alternatives-considered_5">Alternatives Considered</h3>
<p><strong>1. No automatic retry</strong> (status quo before this ADR)
- <strong>Pros</strong>: Simpler, explicit, no hidden behavior
- <strong>Cons</strong>: Every user has to implement retry logic themselves
- <strong>Rejected</strong>: Too much boilerplate, inconsistent handling</p>
<p><strong>2. Configurable retry parameters</strong> (e.g., <code>max_retries</code>, <code>backoff_multiplier</code>)
- <strong>Pros</strong>: More flexible, users can tune for their needs
- <strong>Cons</strong>: More complexity, more surface area for bugs
- <strong>Rejected</strong>: Current defaults work well for 95% of cases, can be added later if needed</p>
<p><strong>3. Retry at higher level</strong> (e.g., in <code>aexecute</code> instead of <code>_aforward</code>/<code>_astream</code>)
- <strong>Pros</strong>: Simpler implementation, single retry point
- <strong>Cons</strong>: Would retry tool calls and other non-LLM logic unnecessarily
- <strong>Rejected</strong>: Parse errors only occur in LLM response parsing, not tool execution</p>
<p><strong>4. Use different retry library</strong> (e.g., <code>backoff</code>, manual implementation)
- <strong>Pros</strong>: Potentially smaller dependency
- <strong>Cons</strong>: Tenacity is well-maintained, widely used, excellent async support
- <strong>Rejected</strong>: Tenacity is the industry standard for Python retry logic</p>
<h3 id="testing-strategy">Testing Strategy</h3>
<p>To keep tests fast, a global <code>fast_retry</code> fixture is used in <code>tests/conftest.py</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">fast_retry</span><span class="p">():</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Patch retry decorators to use no wait time for fast tests.&quot;&quot;&quot;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="n">fast_retry_decorator</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">AdapterParseError</span><span class="p">),</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>        <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>        <span class="n">wait</span><span class="o">=</span><span class="n">wait_none</span><span class="p">(),</span>  <span class="c1"># No wait between retries</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="p">)</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;udspy.module.predict.Predict._aforward&quot;</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>               <span class="n">new</span><span class="o">=</span><span class="n">fast_retry_decorator</span><span class="p">(</span><span class="n">Predict</span><span class="o">.</span><span class="n">_aforward</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">)):</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;udspy.module.predict.Predict._astream&quot;</span><span class="p">,</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>                   <span class="n">new</span><span class="o">=</span><span class="n">fast_retry_decorator</span><span class="p">(</span><span class="n">Predict</span><span class="o">.</span><span class="n">_astream</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">)):</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>            <span class="k">yield</span>
</code></pre></div>
<p>This ensures:
- Tests run instantly (no exponential backoff wait times)
- Retry logic is still exercised in tests
- Production code uses proper backoff timings</p>
<h3 id="migration-guide_5">Migration Guide</h3>
<p><strong>This is a non-breaking change</strong> - no user code needs to be updated.</p>
<p>Users who previously implemented their own retry logic can remove it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Before (manual retry)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>        <span class="k">break</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="k">except</span> <span class="n">AdapterParseError</span><span class="p">:</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>        <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>            <span class="k">raise</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1"># After (automatic retry)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>  <span class="c1"># Retry is automatic</span>
</code></pre></div>
<h3 id="future-considerations_2">Future Considerations</h3>
<ol>
<li><strong>Make retry configurable</strong>: Add <code>max_retries</code> parameter to <code>Predict.__init__()</code> if users need to tune it</li>
<li><strong>Add retry callback</strong>: Allow users to hook into retry events for logging/metrics</li>
<li><strong>Smarter retry</strong>: Analyze parse error type and adjust retry strategy (e.g., don't retry on schema validation errors that won't be fixed by retry)</li>
<li><strong>Retry budget</strong>: Add global retry limit to prevent excessive token usage from many retries</li>
</ol>
<hr />
<h2 id="adr-008-module-callbacks-and-dynamic-tool-management">ADR-008: Module Callbacks and Dynamic Tool Management</h2>
<p><strong>Date</strong>: 2025-10-31</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_7">Context</h3>
<p>Agents often need specialized tools that should only be loaded on demand rather than being available from the start. Use cases include:
- Loading expensive or resource-intensive tools only when needed
- Progressive tool discovery (agent figures out what tools it needs as it works)
- Category-based tool loading (math tools, web tools, data tools)
- Multi-tenant applications with user-specific tool permissions
- Reducing initial token usage and context size</p>
<h3 id="decision_7">Decision</h3>
<p>Implement a module callback system where tools can return special callables decorated with <code>@module_callback</code> that modify the module's available tools during execution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReAct</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">module_callback</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;calculator&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Perform calculations&quot;</span><span class="p">)</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculator</span><span class="p">(</span><span class="n">expression</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="p">{}},</span> <span class="p">{}))</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;load_calculator&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Load calculator tool&quot;</span><span class="p">)</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_calculator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load calculator tool dynamically.&quot;&quot;&quot;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="nd">@module_callback</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_calculator</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="c1"># Get current tools (excluding built-ins)</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="n">current_tools</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;finish&quot;</span><span class="p">,</span> <span class="s2">&quot;user_clarification&quot;</span><span class="p">)</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>        <span class="p">]</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="c1"># Add calculator to available tools</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="n">context</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init_module</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">current_tools</span> <span class="o">+</span> <span class="p">[</span><span class="n">calculator</span><span class="p">])</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="k">return</span> <span class="s2">&quot;Calculator loaded successfully&quot;</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>    <span class="k">return</span> <span class="n">add_calculator</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="c1"># Agent starts with only the loader</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">load_calculator</span><span class="p">])</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="c1"># Agent loads calculator when needed, then uses it</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="n">result</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 157 * 834?&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="implementation-details_4">Implementation Details</h3>
<ol>
<li><strong>@module_callback Decorator</strong>: Simple marker decorator that adds <code>__udspy_module_callback__</code> attribute</li>
<li><strong>Return Value Detection</strong>: After tool execution, check <code>is_module_callback(result)</code></li>
<li><strong>Context Objects</strong>: Pass execution context to callbacks:</li>
<li><code>ReactContext</code>: Includes trajectory history</li>
<li><code>PredictContext</code>: Includes conversation history</li>
<li><code>ModuleContext</code>: Base with module reference</li>
<li><strong>init_module() Pattern</strong>: Unified method to reinitialize tools and regenerate signatures</li>
<li><strong>Tool Persistence</strong>: Dynamically loaded tools remain available until module execution completes</li>
</ol>
<h3 id="key-features_4">Key Features</h3>
<ol>
<li><strong>Decorator-based API</strong>: Clean, explicit marking of module callbacks</li>
<li><strong>Full module access</strong>: Callbacks can inspect and modify module state</li>
<li><strong>Works with all modules</strong>: Predict, ChainOfThought, ReAct</li>
<li><strong>Observation return</strong>: Callbacks return strings that appear in trajectory</li>
<li><strong>Type-safe</strong>: Context objects provide proper type hints</li>
</ol>
<h3 id="use-cases_4">Use Cases</h3>
<ol>
<li>
<p><strong>On-demand capabilities</strong>: Load expensive tools only when needed
   <div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">load_nlp_tools</span><span class="p">,</span> <span class="n">load_vision_tools</span><span class="p">])</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Progressive discovery</strong>: Agent discovers needed tools as it works
   <div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">load_tools</span><span class="p">])</span>  <span class="c1"># Figures out what&#39;s needed</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Multi-tenant</strong>: Load user-specific tools based on permissions
   <div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;load_user_tools&quot;</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_user_tools</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="nd">@module_callback</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_tools</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>        <span class="n">tools</span> <span class="o">=</span> <span class="n">get_tools_for_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="n">context</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init_module</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Loaded tools for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="k">return</span> <span class="n">add_tools</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Category loading</strong>: Load tool groups on demand
   <div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;load_tools&quot;</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_tools</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">callable</span><span class="p">:</span>  <span class="c1"># &quot;math&quot;, &quot;web&quot;, &quot;data&quot;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="nd">@module_callback</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_category_tools</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>        <span class="n">tools</span> <span class="o">=</span> <span class="n">get_tools_by_category</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="n">context</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">init_module</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">current</span> <span class="o">+</span> <span class="n">tools</span><span class="p">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> tools&quot;</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="k">return</span> <span class="n">add_category_tools</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="consequences_7">Consequences</h3>
<p><strong>Benefits</strong>:
- Reduced token usage and context size (only load tools when needed)
- Adaptive agent behavior (discovers capabilities progressively)
- Clean API with decorator pattern
- Full module state access through context
- Works seamlessly with existing tool system
- Enables multi-tenant tool isolation</p>
<p><strong>Trade-offs</strong>:
- Additional complexity in tool execution logic
- Must remember to return string from callbacks (for trajectory)
- Tool persistence requires new instance for fresh state
- Context objects add small memory overhead
- Learning curve for callback pattern</p>
<h3 id="alternatives-considered_6">Alternatives Considered</h3>
<ul>
<li><strong>Direct module mutation</strong>: Rejected due to lack of encapsulation and thread safety concerns</li>
<li><strong>Event system</strong>: Rejected as too complex and heavyweight for this use case</li>
<li><strong>Plugin architecture</strong>: Rejected as overkill for simple tool management</li>
<li><strong>Configuration-based loading</strong>: Rejected as less flexible than programmatic control</li>
</ul>
<h3 id="migration-guide_6">Migration Guide</h3>
<p>Feature is additive - existing code continues to work unchanged.</p>
<p>To use dynamic tools:</p>
<ol>
<li>Define tools that return <code>@module_callback</code> decorated functions</li>
<li>Callbacks receive context and call <code>context.module.init_module(tools=[...])</code></li>
<li>Return string observation from callback</li>
<li>Tool persists for remainder of module execution</li>
</ol>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Before: All tools loaded upfront</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">calculator</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">weather</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># After: Load tools on demand</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">ReAct</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">load_calculator</span><span class="p">,</span> <span class="n">load_search</span><span class="p">,</span> <span class="n">load_weather</span><span class="p">])</span>
</code></pre></div></p>
<h3 id="see-also_2">See Also</h3>
<ul>
<li><a href="../../examples/dynamic_tools/">Dynamic Tools Guide</a></li>
<li><a href="../../api/module_callback/">Module Callbacks API</a></li>
<li><a href="../../examples/tool_calling/">Tool Calling Guide</a></li>
</ul>
<hr />
<h2 id="adr-009-history-management-with-system-prompts">ADR-009: History Management with System Prompts</h2>
<p><strong>Date</strong>: 2025-10-31</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_8">Context</h3>
<p>Chat histories need special handling for system prompts to ensure they're always positioned first in the message list. Module behavior depends on having system instructions properly placed, and tools may manipulate histories during execution. Without dedicated management, it's easy to accidentally insert system prompts mid-conversation or lose them during history manipulation.</p>
<h3 id="decision_8">Decision</h3>
<p>Implement <code>History</code> class with dedicated <code>system_prompt</code> property that ensures system messages always appear first:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">History</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># Add conversation messages</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">history</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">history</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hi there!&quot;</span><span class="p">)</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="c1"># System prompt always goes first, even if set later</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="n">history</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful assistant&quot;</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="n">messages</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">messages</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="c1"># [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a helpful assistant&quot;},</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="c1">#  {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello&quot;},</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="c1">#  {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Hi there!&quot;}]</span>
</code></pre></div>
<h3 id="implementation-details_5">Implementation Details</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">History</span><span class="p">:</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">system_prompt</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="nd">@property</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_prompt</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>    <span class="nd">@system_prompt</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_system_prompt</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>    <span class="nd">@property</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all messages with system prompt first (if set).&quot;&quot;&quot;</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_prompt</span><span class="p">:</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>            <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_system_prompt</span><span class="p">},</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_messages</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>            <span class="p">]</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<p><strong>Key aspects</strong>:
- System prompt stored separately from regular messages
- <code>messages</code> property dynamically constructs full list
- No risk of system prompt appearing mid-conversation
- Simple to update system prompt without rebuilding list
- Clear ownership (History manages system message)</p>
<h3 id="key-features_5">Key Features</h3>
<ol>
<li><strong>Dedicated system_prompt property</strong>: Special handling for system messages</li>
<li><strong>Automatic positioning</strong>: System prompt always first in messages list</li>
<li><strong>Mutable</strong>: Can update system prompt at any time, position maintained</li>
<li><strong>Copy support</strong>: <code>history.copy()</code> includes system prompt</li>
<li><strong>Clear separation</strong>: Regular messages in <code>_messages</code>, system prompt separate</li>
</ol>
<h3 id="use-cases_5">Use Cases</h3>
<ol>
<li>
<p><strong>Module initialization</strong>: Set system prompt per module type
   <div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are a ReAct agent. Use tools to solve tasks.&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Dynamic prompts</strong>: Update based on context or user
   <div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">history</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You are assisting </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. Use their preferences: </span><span class="si">{</span><span class="n">prefs</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Tool manipulation</strong>: Tools can safely update system prompt
   <div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nd">@tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;change_persona&quot;</span><span class="p">)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">change_persona</span><span class="p">(</span><span class="n">persona</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>    <span class="c1"># Tool can access and modify history.system_prompt</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Changed to </span><span class="si">{</span><span class="n">persona</span><span class="si">}</span><span class="s2"> persona&quot;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>History replay</strong>: Maintain system prompt across sessions
   <div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">saved_history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Save including system prompt</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">loaded_history</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">saved_history</span><span class="p">)</span>  <span class="c1"># Restore</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Multi-turn conversations</strong>: System prompt persists correctly
   <div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># System prompt set once, remains first through all turns</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">for</span> <span class="n">user_msg</span> <span class="ow">in</span> <span class="n">conversation</span><span class="p">:</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>    <span class="n">history</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg</span><span class="p">)</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>    <span class="c1"># System prompt still first</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="consequences_8">Consequences</h3>
<p><strong>Benefits</strong>:
- System prompt guaranteed to be first (LLM APIs require this)
- Can update system prompt at any time safely
- Clean property-based API
- Prevents common mistakes (system prompt mid-conversation)
- Supports all history manipulation patterns
- No manual list management required</p>
<p><strong>Trade-offs</strong>:
- Small overhead constructing messages list on each access (negligible)
- System message can't be treated like regular message (by design)
- Slight complexity in History implementation vs. simple list
- Property access pattern may surprise developers expecting plain list</p>
<h3 id="alternatives-considered_7">Alternatives Considered</h3>
<ul>
<li><strong>Insert at index 0</strong>: Rejected as error-prone with mutations, easy to forget</li>
<li><strong>Validation on add</strong>: Rejected as too restrictive, doesn't prevent mid-conversation insertion</li>
<li><strong>Separate system field in messages</strong>: Rejected as doesn't integrate with standard message format</li>
<li><strong>Manual management</strong>: Status quo before this ADR, too error-prone</li>
</ul>
<h3 id="migration-guide_7">Migration Guide</h3>
<p>Existing code using <code>History.add_message()</code> continues to work unchanged.</p>
<p>To use system prompts:</p>
<p><strong>Create with system prompt</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are a helpful assistant&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Set later</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="c1"># ... add messages ...</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">history</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are a math tutor&quot;</span>
</code></pre></div></p>
<p><strong>Update dynamically</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">history</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You are assisting </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></p>
<p><strong>Always correctly positioned</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">messages</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">messages</span>  <span class="c1"># System prompt is always first</span>
</code></pre></div></p>
<h3 id="see-also_3">See Also</h3>
<ul>
<li><a href="../../api/history/">History API Reference</a></li>
<li><a href="../modules/">Module Architecture</a></li>
</ul>
<hr />
<h2 id="adr-010-lm-callable-interface-with-string-prompts">ADR-010: LM Callable Interface with String Prompts</h2>
<p><strong>Date</strong>: 2025-10-31</p>
<p><strong>Status</strong>: Accepted</p>
<h3 id="context_9">Context</h3>
<p>Users want the simplest possible interface for quick LLM queries without needing to construct message dictionaries. Common use cases include:
- Prototyping and experimentation
- Simple scripts and utilities
- Interactive sessions (REPL)
- Learning and onboarding new users
- Quick one-off queries</p>
<p>The existing API required constructing message lists even for simple prompts:
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">response</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">complete</span><span class="p">([{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}],</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></p>
<h3 id="decision_9">Decision</h3>
<p>Enhanced LM base class to accept simple string prompts via <code>__call__()</code> and return just the text content:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">udspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAILM</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;sk-...&quot;</span><span class="p">)</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">lm</span> <span class="o">=</span> <span class="n">OpenAILM</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">default_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="c1"># Simple string prompt - returns just text</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="n">answer</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;What is the capital of France?&quot;</span><span class="p">)</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="nb">print</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>  <span class="c1"># &quot;Paris&quot;</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="c1"># Override model</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="n">answer</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;Explain quantum physics&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">)</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="c1"># With parameters</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="n">answer</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;Write a haiku&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>
<h3 id="implementation-details_6">Implementation Details</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">LM</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="nd">@property</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get default model for this LM instance.&quot;&quot;&quot;</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>    <span class="nd">@overload</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>    <span class="nd">@overload</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>        <span class="n">prompt_or_messages</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_or_messages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt_or_messages</span><span class="p">}]</span>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a>            <span class="c1"># Extract just the text content</span>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;choices&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a>                <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>                    <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">prompt_or_messages</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p><strong>Key aspects</strong>:
1. <strong>Overloaded signatures</strong>: <code>@overload</code> provides proper type hints for both modes
2. <strong>Type-based dispatch</strong>: <code>isinstance(prompt_or_messages, str)</code> determines behavior
3. <strong>Message wrapping</strong>: String prompts wrapped as <code>[{"role": "user", "content": prompt}]</code>
4. <strong>Text extraction</strong>: For strings, extract <code>response.choices[0].message.content</code>
5. <strong>Fallback</strong>: If extraction fails, fall back to <code>str(response)</code>
6. <strong>Optional model</strong>: Made <code>model</code> parameter optional everywhere, uses <code>self.model</code> as default</p>
<h3 id="key-features_6">Key Features</h3>
<ol>
<li><strong>Two modes</strong>:</li>
<li>String input  returns text only (str)</li>
<li>Messages list  returns full response object (Any)</li>
<li><strong>Type-safe</strong>: Proper overloads for IDE autocomplete</li>
<li><strong>Backward compatible</strong>: Existing message-list usage unchanged</li>
<li><strong>Optional model</strong>: Falls back to instance's default model</li>
<li><strong>Passes kwargs</strong>: Temperature, max_tokens, etc. work in both modes</li>
</ol>
<h3 id="use-cases_6">Use Cases</h3>
<ol>
<li>
<p><strong>Prototyping</strong>: Quick tests without boilerplate
   <div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">answer</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;Is Python interpreted or compiled?&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Simple scripts</strong>: One-line LLM queries
   <div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">summary</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarize this in one sentence: </span><span class="si">{</span><span class="n">long_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Interactive sessions</strong>: REPL-friendly API
   <div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;What&#39;s 2+2?&quot;</span><span class="p">)</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="s1">&#39;4&#39;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Learning</strong>: Easiest API for newcomers
   <div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># First udspy program</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="n">lm</span> <span class="o">=</span> <span class="n">OpenAILM</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="s2">&quot;Hello!&quot;</span><span class="p">))</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Utilities</strong>: Helper functions
   <div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">translate</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="k">return</span> <span class="n">lm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Translate to </span><span class="si">{</span><span class="n">target_lang</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="consequences_9">Consequences</h3>
<p><strong>Benefits</strong>:
- Simplest possible API for common case (string prompt)
- No need to construct message dictionaries
- Backward compatible with existing code
- Proper type hints for IDE support (overloads)
- Falls back gracefully if text extraction fails
- Model parameter now optional everywhere</p>
<p><strong>Trade-offs</strong>:
- Slight complexity in <code>__call__</code> implementation (type dispatch)
- String/list dispatch adds minor overhead (negligible)
- Text extraction logic specific to OpenAI response format
- Two different return types require overloads for type safety
- Can't use tools or streaming with string prompt mode</p>
<h3 id="alternatives-considered_8">Alternatives Considered</h3>
<ul>
<li><strong>Separate method</strong> (<code>lm.ask("prompt")</code>): Rejected as less convenient, extra method to learn</li>
<li><strong>Always return text</strong>: Rejected as losing access to full response metadata</li>
<li><strong>Factory function</strong>: Rejected as less object-oriented, doesn't fit with LM abstraction</li>
<li><strong>Auto-detect return type</strong>: Rejected as confusing, breaks type safety</li>
</ul>
<h3 id="migration-guide_8">Migration Guide</h3>
<p>No migration needed - feature is additive and backward compatible.</p>
<p><strong>Before (verbose)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">response</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">complete</span><span class="p">([{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}],</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></p>
<p><strong>After (concise)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">text</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Still supported (full control)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">response</span> <span class="o">=</span> <span class="n">lm</span><span class="p">(</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}],</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">)</span>
</code></pre></div></p>
<h3 id="see-also_4">See Also</h3>
<ul>
<li><a href="../../examples/basic_usage/">Basic Usage Guide</a></li>
<li><a href="../lm/">LM Architecture</a></li>
</ul>
<hr />
<h2 id="template-for-future-adrs">Template for Future ADRs</h2>
<p>When adding new architectural decisions, use this template:</p>
<h2 id="adr-xxx-decision-title">ADR-XXX: Decision Title</h2>
<p><strong>Date</strong>: YYYY-MM-DD</p>
<p><strong>Status</strong>: Proposed | Accepted | Deprecated | Superseded</p>
<h3 id="context_10">Context</h3>
<p>Why was this change needed? What problem does it solve?</p>
<h3 id="decision_10">Decision</h3>
<p>What was decided and implemented? Include code examples if relevant.</p>
<h3 id="implementation-details_7">Implementation Details</h3>
<p>How is this implemented? Key technical details.</p>
<h3 id="consequences_10">Consequences</h3>
<p><strong>Benefits</strong>:
- What are the advantages?</p>
<p><strong>Trade-offs</strong>:
- What are the disadvantages or limitations?</p>
<h3 id="alternatives-considered_9">Alternatives Considered</h3>
<ul>
<li>What other approaches were considered?</li>
<li>Why were they rejected?</li>
</ul>
<h3 id="migration-guide-if-applicable">Migration Guide (if applicable)</h3>
<p>How should users update their code?</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>